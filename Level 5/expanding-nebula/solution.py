right_options = [{0, 1, 4, 5}, {2, 3, 6, 7}, {0, 1, 4, 5}, {2, 3, 6, 7},
                 {8, 9, 12, 13}, {10, 11, 14, 15}, {8, 9, 12, 13}, {10, 11, 14, 15},
                 {0, 1, 4, 5}, {2, 3, 6, 7}, {0, 1, 4, 5}, {2, 3, 6, 7},
                 {8, 9, 12, 13}, {10, 11, 14, 15}, {8, 9, 12, 13}, {10, 11, 14, 15}
                 ]
down_options = [{0, 1, 2, 3}, {4, 5, 6, 7}, {8, 9, 10, 11}, {12, 13, 14, 15},
                {0, 1, 2, 3}, {4, 5, 6, 7}, {8, 9, 10, 11}, {12, 13, 14, 15},
                {0, 1, 2, 3}, {4, 5, 6, 7}, {8, 9, 10, 11}, {12, 13, 14, 15},
                {0, 1, 2, 3}, {4, 5, 6, 7}, {8, 9, 10, 11}, {12, 13, 14, 15}
                ]
down_right_options = [{0, 1, 2, 3, 4, 5, 6, 7}, {8, 9, 10, 11, 12, 13, 14, 15}, {0, 1, 2, 3, 4, 5, 6, 7},
                      {8, 9, 10, 11, 12, 13, 14, 15},
                      {0, 1, 2, 3, 4, 5, 6, 7}, {8, 9, 10, 11, 12, 13, 14, 15}, {0, 1, 2, 3, 4, 5, 6, 7},
                      {8, 9, 10, 11, 12, 13, 14, 15},
                      {0, 1, 2, 3, 4, 5, 6, 7}, {8, 9, 10, 11, 12, 13, 14, 15}, {0, 1, 2, 3, 4, 5, 6, 7},
                      {8, 9, 10, 11, 12, 13, 14, 15},
                      {0, 1, 2, 3, 4, 5, 6, 7}, {8, 9, 10, 11, 12, 13, 14, 15}, {0, 1, 2, 3, 4, 5, 6, 7},
                      {8, 9, 10, 11, 12, 13, 14, 15}
                      ]
down_left_options = [{0, 1, 2, 3, 8, 9, 10, 11}, {0, 1, 2, 3, 8, 9, 10, 11}, {4, 5, 6, 7, 12, 13, 14, 15},
                     {4, 5, 6, 7, 12, 13, 14, 15},
                     {0, 1, 2, 3, 8, 9, 10, 11}, {0, 1, 2, 3, 8, 9, 10, 11}, {4, 5, 6, 7, 12, 13, 14, 15},
                     {4, 5, 6, 7, 12, 13, 14, 15},
                     {0, 1, 2, 3, 8, 9, 10, 11}, {0, 1, 2, 3, 8, 9, 10, 11}, {4, 5, 6, 7, 12, 13, 14, 15},
                     {4, 5, 6, 7, 12, 13, 14, 15},
                     {0, 1, 2, 3, 8, 9, 10, 11}, {0, 1, 2, 3, 8, 9, 10, 11}, {4, 5, 6, 7, 12, 13, 14, 15},
                     {4, 5, 6, 7, 12, 13, 14, 15}
                     ]
up_right_options = [{0, 1, 4, 5, 8, 9, 12, 13}, {0, 1, 4, 5, 8, 9, 12, 13}, {0, 1, 4, 5, 8, 9, 12, 13},
                    {0, 1, 4, 5, 8, 9, 12, 13},
                    {2, 3, 6, 7, 10, 11, 14, 15}, {2, 3, 6, 7, 10, 11, 14, 15}, {2, 3, 6, 7, 10, 11, 14, 15},
                    {2, 3, 6, 7, 10, 11, 14, 15},
                    {0, 1, 4, 5, 8, 9, 12, 13}, {0, 1, 4, 5, 8, 9, 12, 13}, {0, 1, 4, 5, 8, 9, 12, 13},
                    {0, 1, 4, 5, 8, 9, 12, 13},
                    {2, 3, 6, 7, 10, 11, 14, 15}, {2, 3, 6, 7, 10, 11, 14, 15}, {2, 3, 6, 7, 10, 11, 14, 15},
                    {2, 3, 6, 7, 10, 11, 14, 15},
                    ]
up_options = [{0, 4, 8, 12}, {0, 4, 8, 12}, {0, 4, 8, 12}, {0, 4, 8, 12},
              {1, 5, 9, 13}, {1, 5, 9, 13}, {1, 5, 9, 13}, {1, 5, 9, 13},
              {2, 6, 10, 14}, {2, 6, 10, 14}, {2, 6, 10, 14}, {2, 6, 10, 14},
              {3, 7, 11, 15}, {3, 7, 11, 15}, {3, 7, 11, 15}, {3, 7, 11, 15}]
left_options = [{0, 2, 8, 10}, {0, 2, 8, 10}, {1, 3, 9, 11}, {1, 3, 9, 11},
                {0, 2, 8, 10}, {0, 2, 8, 10}, {1, 3, 9, 11}, {1, 3, 9, 11},
                {4, 6, 12, 14}, {4, 7, 12, 14}, {5, 7, 13, 15}, {5, 7, 13, 15},
                {4, 6, 12, 14}, {4, 7, 12, 14}, {5, 7, 13, 15}, {5, 7, 13, 15}]
gas_options = {1, 2, 4, 8}
empty_options = {0, 3, 5, 6, 7, 9, 10, 11, 12, 13, 14, 15}


def solution(g):
    global row_length, mat_length
    row_length, mat_length = len(g[0]), len(g)
    # mat = get_starting_matrix(g)
    return construct_solution(g)


def construct_solution(g):
    current_row = [[_] for _ in gas_options] if g[0][0] else [[_] for _ in empty_options]
    for j in xrange(1, row_length):
        temp = list()
        for opt in current_row:
            cur_possibilities = gas_options if g[0][j] else empty_options
            cur_possibilities = cur_possibilities & right_options[opt[-1]]
            if cur_possibilities:
                temp.append([opt + [_] for _ in cur_possibilities])
        current_row = reduce(lambda x, y: x + y, temp)
    prev_row = current_row
    visited_states, visited_rows = dict(), dict()
    for i in xrange(1, mat_length):
        current_row = list()
        # case j = 0
        for k, prev_opt in enumerate(prev_row):
            if g[i][0]:
                cur_opt = gas_options & down_options[prev_opt[0]] & down_left_options[prev_opt[1]]
            else:
                cur_opt = empty_options & down_options[prev_opt[0]] & down_left_options[prev_opt[1]]
            current_row.append([[_] for _ in cur_opt])
        # case 0 < j < row_length - 1
        for j in xrange(1, row_length - 1):
            for k, prev_opt in enumerate(prev_row):
                temp = list()
                for opt in current_row[k]:
                    state = (prev_opt[j - 1], prev_opt[j], prev_opt[j + 1], opt[-1], g[i][j])

                    if state in visited_states:
                        if visited_states[state]:
                            temp += [opt + [_] for _ in visited_states[state]]
                    else:
                        cur_possibilities = gas_options if g[i][j] else empty_options
                        cur_possibilities = cur_possibilities & \
                                            down_right_options[prev_opt[j - 1]] & \
                                            down_options[prev_opt[j]] & \
                                            down_left_options[prev_opt[j + 1]] & \
                                            right_options[opt[-1]]
                        if cur_possibilities:
                            temp += [opt + [_] for _ in cur_possibilities]
                        visited_states[state] = cur_possibilities
                current_row[k] = temp
    # case j = row_length
        for k, prev_opt in enumerate(prev_row):
            temp = list()
            for opt in current_row[k]:
                cur_possibilities = gas_options if g[i][row_length - 1] else empty_options
                cur_possibilities = cur_possibilities & \
                                    down_right_options[prev_opt[row_length - 2]] & \
                                    down_options[prev_opt[row_length - 1]] & \
                                    right_options[opt[-1]]
                if cur_possibilities:
                    temp += [opt + [_] for _ in cur_possibilities]
            current_row[k] = temp
        prev_row = reduce(lambda x, y: x + y, current_row)
        print(prev_row)
        print
        print
        print
    return len(prev_row)


# def convert_matrix(input_matrix):
#     output = [[0 for _ in xrange(len(input_matrix[0]) + 1)] for _ in xrange(len(input_matrix) + 1)]
#     for i in xrange(len(input_matrix)):
#         for j in xrange(len(input_matrix[0])):
#             a = [int(_) for _ in bin(input_matrix[i][j]).split('b')[1]]
#             for _ in xrange(4 - len(a)):
#                 a.insert(0, 0)
#             output[i][j] = a[0]
#             if j == len(input_matrix[0]) - 1:
#                 output[i][j + 1] = a[1]
#             if i == len(input_matrix) - 1:
#                 output[i + 1][j], output[i + 1][j + 1] = a[2], a[3]
#     return output


input_0 = [[True, True, False, True, False, True, False, True, True, False],
           [True, True, False, False, False, False, True, True, True, False],
           [True, True, False, False, False, False, False, False, False, True],
           [False, True, False, False, False, False, True, True, False, False]]

input_1 = [[True, False, True], [False, True, False], [True, False, True]]

input_2 = [[True, False, True, False, False, True, True, True],
           [True, False, True, False, False, False, True, False],
           [True, True, True, False, False, False, True, False],
           [True, False, True, False, False, False, True, False],
           [True, False, True, False, False, True, True, True]]

input_3 = [[True, True, True], [False, True, False], [True, False, True]]
import random

ROWS = 7
COLUMNS = 11
# input_3 = get_next_state([[random.randint(0, 1) for _ in xrange(COLUMNS)] for _ in xrange(ROWS)])
inputs = [input_0, input_1, input_2]
# inputs = [input_2]
for g in inputs:
    # for i in xrange(100):
        # for r in g:
        #     print r
        # print
        print solution(g)

# # get_possibilities_by_neighbors()
# # for k, v in get_possibilities_by_neighbors().items():
# #     print k, v
